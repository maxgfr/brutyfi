name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Setup Rust (for Cargo.lock generation)
        uses: dtolnay/rust-toolchain@stable

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 23
          extra_plugins: |
            @semantic-release/changelog@6
            @semantic-release/git@10
            @semantic-release/github@10
            @semantic-release/exec@6
            conventional-changelog-conventionalcommits@7

      - name: Debug outputs
        run: |
          echo "new_release_published: ${{ steps.semantic.outputs.new_release_published }}"
          echo "new_release_version: ${{ steps.semantic.outputs.new_release_version }}"

  build-macos:
    name: Build macOS (DMG)
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin # Apple Silicon
          - x86_64-apple-darwin # Intel
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
        env:
          RUSTFLAGS: >
            ${{ matrix.target == 'aarch64-apple-darwin' && '-C target-cpu=apple-m1' || '-C target-cpu=x86-64-v3' }}

      - name: Create macOS App Bundle (ad-hoc signed)
        run: |
          APP_NAME="BrutiFi"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"

          APP_DIR="target/release/${APP_NAME}.app"
          CONTENTS_DIR="${APP_DIR}/Contents"
          MACOS_DIR="${CONTENTS_DIR}/MacOS"
          RESOURCES_DIR="${CONTENTS_DIR}/Resources"

          rm -rf "${APP_DIR}"
          mkdir -p "${MACOS_DIR}"
          mkdir -p "${RESOURCES_DIR}"

          cp "target/${TARGET}/release/brutifi" "${MACOS_DIR}/brutifi"
          chmod +x "${MACOS_DIR}/brutifi"

          cp "assets/icon.icns" "${RESOURCES_DIR}/AppIcon.icns"

            cat << 'EOF' | sed 's/^          //' > "${CONTENTS_DIR}/Info.plist"
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
              <key>CFBundleExecutable</key>
              <string>brutifi</string>
              <key>CFBundleIdentifier</key>
              <string>com.maxgfr.brutifi</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon.icns</string>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
            </dict>
            </plist>
            EOF

          codesign --force --deep --sign - "${APP_DIR}"

      - name: Create DMG
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          DMG_NAME="BrutiFi-${VERSION}-macOS-${ARCH}.dmg"
          DMG_TEMP="dmg_temp"

          mkdir -p "${DMG_TEMP}"
          cp -R "target/release/BrutiFi.app" "${DMG_TEMP}/BrutiFi.app"
          ln -s /Applications "${DMG_TEMP}/Applications"

          echo "BrutiFi v${VERSION}" > "${DMG_TEMP}/README.txt"
          echo "" >> "${DMG_TEMP}/README.txt"
          echo "Installation:" >> "${DMG_TEMP}/README.txt"
          echo "1. Drag 'BrutiFi.app' to Applications folder" >> "${DMG_TEMP}/README.txt"
          echo "2. Run: sudo /Applications/BrutiFi.app/Contents/MacOS/brutifi" >> "${DMG_TEMP}/README.txt"
          echo "" >> "${DMG_TEMP}/README.txt"
          echo "For more information: https://github.com/maxgfr/bruteforce-wifi" >> "${DMG_TEMP}/README.txt"

          hdiutil create -volname "BrutiFi" \
            -srcfolder "${DMG_TEMP}" \
            -ov \
            -format UDZO \
            -imagekey zlib-level=9 \
            "${DMG_NAME}"

          rm -rf "${DMG_TEMP}"

      - name: Generate SHA256
        run: |
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          DMG_NAME="BrutiFi-${VERSION}-macOS-${ARCH}.dmg"
          shasum -a 256 "${DMG_NAME}" > "${DMG_NAME}.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            BrutiFi-*.dmg
            BrutiFi-*.sha256

  build-windows:
    name: Build Windows (EXE)
    needs: release
    # if: needs.release.outputs.new_release_published == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install WinPcap SDK
        run: |
          Invoke-WebRequest -Uri "https://www.winpcap.org/install/bin/WpdPack_4_1_2.zip" -OutFile "WpdPack.zip"
          Expand-Archive -Path "WpdPack.zip" -DestinationPath "C:\"
          echo "LIB=C:\WpdPack\Lib\x64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build release binary
        run: cargo build --release
        env:
          RUSTFLAGS: "-C target-cpu=x86-64-v3"

      - name: Create installer with WiX
        run: |
          $VERSION = "${{ needs.release.outputs.new_release_version }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "0.0.0-dev.${{ github.run_number }}" }
          $INSTALLER_NAME = "WiFi-Bruteforce-${VERSION}-Windows-x64.msi"

          # Simple ZIP for now (can be enhanced with WiX later)
          Compress-Archive -Path "target\release\brutifi.exe" -DestinationPath "BrutiFi-${VERSION}-Windows-x64.zip"

      - name: Generate SHA256
        run: |
          $VERSION = "${{ needs.release.outputs.new_release_version }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "0.0.0-dev.${{ github.run_number }}" }
          $FILE = "BrutiFi-${VERSION}-Windows-x64.zip"
          Get-FileHash -Algorithm SHA256 -Path $FILE | ForEach-Object { "$($_.Hash.ToLower())  $FILE" } | Out-File -FilePath "${FILE}.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            BrutiFi-*.zip
            BrutiFi-*.sha256

  build-linux:
    name: Build Linux
    needs: release
    # if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev libxkbcommon-dev libwayland-dev libgtk-3-dev

      - name: Build release binary
        run: cargo build --release

      - name: Create Archive
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          ARCHIVE_NAME="BrutiFi-${VERSION}-Linux-x86_64.tar.gz"

          mkdir -p release_dist
          cp target/release/brutifi release_dist/

          tar -czf "$ARCHIVE_NAME" -C release_dist .

      - name: Generate SHA256
        run: |
          FILE=$(ls BrutiFi-*-Linux-*.tar.gz | head -n 1)
          shasum -a 256 "$FILE" > "$FILE.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            BrutiFi-*-Linux-*.tar.gz
            BrutiFi-*-Linux-*.sha256
