name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Semantic Release
    runs-on: macos-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Setup Rust (for Cargo.lock generation)
        uses: dtolnay/rust-toolchain@stable

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 23
          extra_plugins: |
            @semantic-release/changelog@6
            @semantic-release/git@10
            @semantic-release/github@10
            @semantic-release/exec@6
            conventional-changelog-conventionalcommits@7

      - name: Debug outputs
        run: |
          echo "new_release_published: ${{ steps.semantic.outputs.new_release_published }}"
          echo "new_release_version: ${{ steps.semantic.outputs.new_release_version }}"

  build-macos:
    name: Build macOS (DMG)
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin # Apple Silicon
          - x86_64-apple-darwin # Intel
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_release_published == 'true' && format('v{0}', needs.release.outputs.new_release_version) || '' }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
        env:
          RUSTFLAGS: >
            ${{ matrix.target == 'aarch64-apple-darwin' && '-C target-cpu=apple-m1' || '-C target-cpu=x86-64-v3' }}

      - name: Create macOS App Bundle (ad-hoc signed)
        run: |
          APP_NAME="BrutiFi"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"

          APP_DIR="target/release/${APP_NAME}.app"
          CONTENTS_DIR="${APP_DIR}/Contents"
          MACOS_DIR="${CONTENTS_DIR}/MacOS"
          RESOURCES_DIR="${CONTENTS_DIR}/Resources"

          rm -rf "${APP_DIR}"
          mkdir -p "${MACOS_DIR}"
          mkdir -p "${RESOURCES_DIR}"

          cp "target/${TARGET}/release/brutifi" "${MACOS_DIR}/brutifi"
          chmod +x "${MACOS_DIR}/brutifi"

          cp "assets/icon.icns" "${RESOURCES_DIR}/AppIcon.icns"

            cat <<EOF | sed 's/^          //' > "${CONTENTS_DIR}/Info.plist"
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
              <key>CFBundleExecutable</key>
              <string>brutifi</string>
              <key>CFBundleIdentifier</key>
              <string>com.maxgfr.brutifi</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon.icns</string>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSMultipleInstancesProhibited</key>
              <true/>
            </dict>
            </plist>
            EOF

          codesign --force --deep --sign - "${APP_DIR}"

      - name: Create DMG
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          DMG_NAME="BrutiFi-${VERSION}-macOS-${ARCH}.dmg"
          DMG_TEMP="dmg_temp"

          mkdir -p "${DMG_TEMP}"
          cp -R "target/release/BrutiFi.app" "${DMG_TEMP}/BrutiFi.app"
          ln -s /Applications "${DMG_TEMP}/Applications"

          hdiutil create -volname "BrutiFi" \
            -srcfolder "${DMG_TEMP}" \
            -ov \
            -format UDZO \
            -imagekey zlib-level=9 \
            "${DMG_NAME}"

          rm -rf "${DMG_TEMP}"

      - name: Generate SHA256
        run: |
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'arm64' || 'x86_64' }}"
          VERSION="${{ needs.release.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0-dev.${{ github.run_number }}"; fi
          DMG_NAME="BrutiFi-${VERSION}-macOS-${ARCH}.dmg"
          shasum -a 256 "${DMG_NAME}" > "${DMG_NAME}.sha256"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: needs.release.outputs.new_release_published == 'true'
        with:
          tag_name: v${{ needs.release.outputs.new_release_version }}
          files: |
            BrutiFi-*.dmg
            BrutiFi-*.sha256
